<!DOCTYPE html>
<html>
<head>
    <title>Graft Compatibility v3.0</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <style>
        table { border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid black; padding: 5px; text-align: left; }
        #suggestions { 
            position: absolute; 
            background: white; 
            border: 1px solid #ccc; 
            max-height: 200px; 
            overflow-y: auto; 
            width: 300px; 
            z-index: 1000; 
        }
        #suggestions div { padding: 5px; cursor: pointer; }
        #suggestions div:hover { background: #f0f0f0; }
        #baseline { width: 300px; }
    </style>
</head>
<body>
    <h1>Graft Compatibility Checker v3.0</h1>
    <input type="text" id="baseline" placeholder="Type species name..." onkeyup="debounceSuggest(this.value)">
    <div id="suggestions"></div>
    <button onclick="runScript()">Calculate</button>
    <table id="output" border="1"></table>

    <script>
        let speciesData = [];
        fetch('data.json')  // Swap to 'data.json.gz' when compressed
            .then(response => response.json())
            .then(data => { 
                speciesData = data; 
                console.log("Data loaded:", speciesData.length, "species");
            })
            .catch(err => console.error('Data load failed:', err));

        let debounceTimeout;
        function debounceSuggest(value) {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => suggest(value), 200);  // 200ms debounce
        }

        function suggest(value) {
            let suggestions = document.getElementById("suggestions");
            if (!value || speciesData.length === 0) { 
                suggestions.innerHTML = ""; 
                return; 
            }
            let matches = speciesData.filter(s => 
                s.Species.toLowerCase().includes(value.toLowerCase())
            ).slice(0, 10);
            suggestions.innerHTML = matches.length > 0 
                ? matches.map(s => `<div onclick="selectSpecies('${s.Species}')">${s.Species}</div>`).join("")
                : "<div>No matches found</div>";
        }

        function selectSpecies(species) {
            document.getElementById("baseline").value = species;
            document.getElementById("suggestions").innerHTML = "";
        }

        async function loadPyodideAndRun() {
            let pyodide = await loadPyodide();
            await pyodide.loadPackage("pandas");
            return pyodide;
        }

        let pyodideReady = loadPyodideAndRun();

        async function runScript() {
            let pyodide = await pyodideReady;
            let baseline = document.getElementById("baseline").value;
            let output = document.getElementById("output");

            if (!speciesData.some(s => s.Species === baseline)) {
                output.innerHTML = "Error: Species not found";
                return;
            }

            output.innerHTML = "Calculating...";  // Feedback during calc
            let pythonCode = `
import pandas as pd

data = ${JSON.stringify(speciesData)};
df = pd.DataFrame(data)

def graft_compatibility(base, candidate):
    size_diff = abs(float(base["Vessel_Size_μm"]) - float(candidate["Vessel_Size_μm"])) / float(base["Vessel_Size_μm"])
    size_score = max(0, 1 - size_diff / 0.2) * 60
    porosity_score = 30 if base["Porosity"] == candidate["Porosity"] else 0
    density_diff = abs(float(base["Vessel_Density_per_mm2"]) - float(candidate["Vessel_Density_per_mm2"])) / float(base["Vessel_Density_per_mm2"])
    density_score = max(0, 1 - density_diff / 0.3) * 10
    return round(size_score + porosity_score + density_score, 2)

baseline = df[df["Species"] == "${baseline}"].iloc[0]
results = []
for i, row in df.iterrows():
    if row["Species"] != "${baseline}":
        compatibility = graft_compatibility(baseline, row)
        results.append({"Species": row["Species"], "Family": row["Family"], "Compatibility_Score": str(compatibility)})

results_df = pd.DataFrame(results).sort_values(by="Compatibility_Score", ascending=False)
output = "Species||Family||Compatibility_Score\\n" + "\\n".join(
    f"{row['Species']}||{row['Family']}||{row['Compatibility_Score']}" for _, row in results_df.iterrows()
)
output
            `;

            try {
                let result = await pyodide.runPythonAsync(pythonCode);
                let lines = result.split("\n");
                let table = "<tr><th>Species</th><th>Family</th><th>Compatibility Score</th></tr>";
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        let [species, family, score] = lines[i].split("||");
                        table += `<tr><td>${species}</td><td>${family}</td><td>${score}</td></tr>`;
                    }
                }
                output.innerHTML = table;
            } catch (err) {
                output.innerHTML = "Error: " + err.message;
            }
        }
    </script>
</body>
</html>
