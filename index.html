<!DOCTYPE html>
<html>
<head>
    <title>Graft Compatibility v4.0</title>
    <style>
        table { border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid black; padding: 5px; text-align: left; }
        #suggestions { 
            position: absolute; 
            background: white; 
            border: 1px solid #ccc; 
            max-height: 200px; 
            overflow-y: auto; 
            width: 300px; 
            z-index: 1000; 
        }
        #suggestions div { padding: 5px; cursor: pointer; }
        #suggestions div:hover { background: #f0f0f0; }
        #baseline { width: 300px; }
    </style>
</head>
<body>
    <h1>Graft Compatibility Checker v4.0</h1>
    <input type="text" id="baseline" placeholder="Type species name..." onkeyup="debounceSuggest(this.value)">
    <div id="suggestions"></div>
    <button onclick="runScript()">Calculate</button>
    <table id="output" border="1"></table>

    <script>
        let speciesData = [];
        fetch('data.json')
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => { 
                speciesData = data; 
                console.log("Data loaded:", speciesData.length, "species");
            })
            .catch(err => console.error('Data load failed:', err));

        let debounceTimeout;
        function debounceSuggest(value) {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => suggest(value), 200);
        }

        function suggest(value) {
            let suggestions = document.getElementById("suggestions");
            if (!value || speciesData.length === 0) { 
                suggestions.innerHTML = ""; 
                return; 
            }
            let matches = speciesData.filter(s => 
                s.Species.toLowerCase().includes(value.toLowerCase())
            ).slice(0, 10);
            suggestions.innerHTML = matches.length > 0 
                ? matches.map(s => `<div onclick="selectSpecies('${s.Species}')">${s.Species}</div>`).join("")
                : "<div>No matches found</div>";
        }

        function selectSpecies(species) {
            document.getElementById("baseline").value = species;
            document.getElementById("suggestions").innerHTML = "";
        }

        function graftCompatibility(base, candidate) {
            let sizeDiff = Math.abs(base.Vessel_Size_μm - candidate.Vessel_Size_μm) / base.Vessel_Size_μm;
            let sizeScore = Math.max(0, 1 - sizeDiff / 0.2) * 60;
            let porosityScore = base.Porosity === candidate.Porosity ? 30 : 0;
            let densityDiff = Math.abs(base.Vessel_Density_per_mm2 - candidate.Vessel_Density_per_mm2) / base.Vessel_Density_per_mm2;
            let densityScore = Math.max(0, 1 - densityDiff / 0.3) * 10;
            return (sizeScore + porosityScore + densityScore).toFixed(2);
        }

        function runScript() {
            let baselineName = document.getElementById("baseline").value;
            let output = document.getElementById("output");

            if (!speciesData.some(s => s.Species === baselineName)) {
                output.innerHTML = "Error: Species not found";
                return;
            }

            output.innerHTML = "Calculating...";
            let baseline = speciesData.find(s => s.Species === baselineName);
            let results = speciesData
                .filter(s => s.Species !== baselineName)
                .map(s => ({
                    Species: s.Species,
                    Family: s.Family,
                    Compatibility_Score: graftCompatibility(baseline, s)
                }))
                .sort((a, b) => b.Compatibility_Score - a.Compatibility_Score);

            let table = "<tr><th>Species</th><th>Family</th><th>Compatibility Score</th></tr>";
            results.forEach(row => {
                table += `<tr><td>${row.Species}</td><td>${row.Family}</td><td>${row.Compatibility_Score}</td></tr>`;
            });
            output.innerHTML = table;
        }
    </script>
</body>
</html>
